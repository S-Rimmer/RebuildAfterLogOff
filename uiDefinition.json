{
	"$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json",
	"view": {
		"kind": "Form",
		"properties": {
			"title": "Azure Virtual Desktop Host Pool Rebuild VM if No Users",
			"steps": [
				{
					"name": "basics",
					"label": "Basics",
					"elements": [
						{
							"name": "resourceScope",
							"type": "Microsoft.Common.ResourceScope",
							"instanceDetailsLabel": "Deploy Automation Account",
							"subscription": {
								"constraints": {
									"validations": []
								}
							}
						},
						{
							"name": "HostPoolsApi",
							"type": "Microsoft.Solutions.ArmApiControl",
							"request": {
								"method": "GET",
								"path": "[concat(steps('basics').resourceScope.subscription.id, '/providers/Microsoft.DesktopVirtualization/hostpools?api-version=2021-07-12')]"
							}
						},
						{
							"name": "ResGroupsApi",
							"type": "Microsoft.Solutions.ArmApiControl",
							"request": {
								"method": "GET",
								"path": "[concat(steps('basics').resourceScope.subscription.id, '/resourceGroups?api-version=2021-04-01')]"
							}
						}
					]
				},
				{
					"name": "HostPoolChoice",
					"label": "Host Pool",
					"elements": [
						{
							"name": "AutomationAcctName",
							"type": "Microsoft.Common.TextBox",
							"label": "Automation Account Name",
							"subLabel": "",
							"defaultValue": "aa-avd-check-rebuild-logoff",
							"toolTip": "Automation Account will be used to incorporate a Runbook with the Powershell script which will then run every 15 minutes. See script for additional information.",
							"constraints": {
								"required": true,
								"regex": "^[a-zA-Z0-9][a-zA-Z0-9-]{4,48}[a-zA-Z0-9]$",
								"validationMessage": "The account name is invalid. It must not be empty, and must start and end with a letter or a number. The name can contain only letters, numbers and hyphens(-). The length must be from 6 to 50 characters."
							},
							"visible": true
						},
						{
							"name": "RunbookName",
							"type": "Microsoft.Common.TextBox",
							"label": "Runbook Name",
							"subLabel": "",
							"defaultValue": "AVD-CheckAndRebuildAtLogoff",
							"toolTip": "Automation Account will be used to incorporate a Runbook with the Powershell script which will then run every 15 minutes. See script for additional information.",
							"constraints": {
								"required": true,
								"regex": "^[a-zA-Z0-9][a-zA-Z0-9-]{4,48}[a-zA-Z0-9]$",
								"validationMessage": "The account name is invalid. It must not be empty, and must start and end with a letter or a number. The name can contain only letters, numbers and hyphens(-). The length must be from 6 to 50 characters."
							},
							"visible": true
						},
						{
							"name": "postScriptName",
							"type": "Microsoft.Common.TextBox",
							"label": "Automation Account PowerShell Script Name",
							"toolTip": "",
							"defaultValue": "AVD-CheckAndRebuildAtLogoff.ps1"
						},
						{
							"name": "ifNotUsedInHrs",
							"type": "Microsoft.Common.Slider",
							"min": 1,
							"max": 24,
							"label": "After use Wait to Rebuild",
							"subLabel": "Hrs",
							"defaultValue": 3,
							"showStepMarkers": false,
							"toolTip": "Pick the number of hours to wait to rebuild the VM. Minimum of 1 hour up to 24 hours.",
							"constraints": {
								"required": true
							},
							"visible": true
						},
						{
							"name": "logAnalyticsWSApi",
							"type": "Microsoft.Solutions.ArmApiControl",
							"request": {
								"method": "GET",
								"path": "[concat(steps('basics').resourceScope.subscription.id, '/providers/Microsoft.OperationalInsights/workspaces?api-version=2022-10-01')]"
							}
						},
						{
							"name": "logAnalyticsWS",
							"type": "Microsoft.Common.DropDown",
							"visible": true,
							"label": "Log Analytics Workspace",
							"defaultValue": "",
							"toolTip": "Select an existing container.",
							"constraints": {
								"required": true,
								"allowedValues": "[map(steps('HostPoolChoice').logAnalyticsWSApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":{\"Name\":\"', item.name, '\", \"ResourceId\":\"', item.id, '\", \"WorkspaceId\":\"', item.properties.customerId, '\"}}')))]"
							}
						},
						{
							"name": "AVDResourceGroupName",
							"type": "Microsoft.Common.DropDown",
							"label": "Host Pool Object Resource Group",
							"multiselect": false,
							"defaultValue": "[]",
							"selectAll": false,
							"toolTip": "The Resource Group where all AVD resources are deployed to include VMs.",
							"filter": true,
							"filterPlaceholder": "Filter Resource Groups...",
							"defaultDescription": "A value for selection",
							"constraints": {
								"allowedValues": "[map(steps('basics').ResGroupsApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
								"required": true
							},
							"visible": true
						},
						{
							"name": "HostPools",
							"type": "Microsoft.Common.DropDown",
							"label": "Host Pool",
							"multiselect": false,
							"selectAll": false,
							"defaultValue": "[]",
							"toolTip": "Select Host Pool to monitor and rebuild VMs.",
							"filter": true,
							"filterPlaceholder": "Filter Host Pools...",
							"defaultDescription": "A value for selection",
							"constraints": {
								"allowedValues": "[map(steps('basics').HostPoolsApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]",
								"required": true
							},
							"visible": true
						},
						{
							"name": "TemplateSpec",
							"type": "Microsoft.Solutions.ResourceSelector",
							"label": "Template Spec for Rebuild",
							"toolTip": "Select the Template Spec that includes all the ARM template to add a VM to the Host Pool.",
							"resourceType": "Microsoft.Resources/templateSpecs",
							"constraints": {
								"required": true
							},
							"infoMessages": [],
							"visible": true
						},
                        {
                            "name": "TemplateSpecVersion",
							"type": "Microsoft.Common.TextBox",
							"label": "Template Spec Version",
							"subLabel": "",
							"defaultValue": "",
							"toolTip": "Automation Account will be used to incorporate a Runbook with the Powershell script which will then run every 15 minutes. See script for additional information.",
							"constraints": {
								"required": true
							},
							"visible": true
						},
						{
							"name": "kvDomain",
							"type": "Microsoft.Solutions.ResourceSelector",
							"label": "Select Keyvault",
							"resourceType": "Microsoft.KeyVault/vaults",
							"toolTip": "Select Keyvault which contains the secrets for the Domain Credentials.",
							"constraints": {
								"required": true
							},
							"visible": true
						},
						{
							"name": "kvLocalSecretName",
							"type": "Microsoft.Common.TextBox",
							"defaultValue": "LocalAdminPassword",
							"label": "KeyVault Secret Name (Local Admin Credential)",
							"toolTip": "The Name of the KeyVault secret that contains the encrypted password as a value.",
							"visible": true
						}
					]
				}
			]
		},
		"outputs": {
			"parameters": {
                "AutomationAccountName": "[steps('HostPoolChoice').AutomationAcctName]",
				"AVDResourceGroup": "[steps('HostPoolChoice').AVDResourceGroupName]",
				"HostPoolName": "[steps('HostPoolChoice').HostPools]",
                "IfNotUsedInHours": "[steps('HostPoolChoice').ifNotUsedInHrs]",
                "KeyVaultName": "[steps('HostPoolChoice').kvDomain.name]",
                "KeyVaultVMAdmin": "[steps('HostPoolChoice').kvLocalSecretName]",
				"Location": "[steps('basics').resourceScope.location.name]",
                "LogAnalyticsWorkspace": "[steps('HostPoolChoice').logAnalyticsWS]",
                "ResourceGroupName": "[steps('basics').resourceScope.resourceGroup.name]",
				"RunbookName": "[steps('HostPoolChoice').RunbookName]",
				"RunbookScript": "[steps('HostPoolChoice').postScriptName]",
                "TemplateSpecResId": "[steps('HostPoolChoice').TemplateSpec.id]",
                "TemplateSpecVersion": "[steps('HostPoolChoice').TemplateSpecVersion]",
                "imageId": "[steps('HostPoolChoice').TemplateSpec.id]",
                "virtualMachineName": "[steps('HostPoolChoice').HostPools]",
                "location": "[steps('basics').resourceScope.location.name]",
                "vmSize": "[steps('HostPoolChoice').HostPools]",
                "osDiskType": "[steps('HostPoolChoice').HostPools]",
                "virtualMachineComputerName": "[steps('HostPoolChoice').HostPools]",
                "adminUsername": "[steps('HostPoolChoice').HostPools]",
                "adminPassword": "[steps('HostPoolChoice').HostPools]",
                "networkInterfaceName": "[steps('HostPoolChoice').HostPools]"
			},
			"kind": "Subscription",
			"location": "[steps('basics').resourceScope.location.name]",
			"subscriptionId": "[steps('basics').resourceScope.subscription.id]"
		}
	}
}
